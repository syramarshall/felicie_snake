<html lang="en">

<head>
  <title>Feli meets Snake</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://fonts.googleapis.com/css?family=Orbitron:700" rel="stylesheet">
  <link href="Style/MainCSS.css" rel="stylesheet">
  <style>
    html,
    body {
      height: 100%;
      background-color: black;
      font-family: 'Orbitron', sans-serif;
    }

    #main-receiver {
      width: 600px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      min-width: 300px;
      max-width: 600px;
    }

    #mCodec>* {
      padding: 10px;
    }

    #main-con {
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: row;
    }

    .grid-box {
      width: 250px;
    }

    .codec-col {
      border: 1px solid #03FB8D;
      height: 300px;
    }

    #text-con {
      border: 1px solid #03FB8D;
      height: 300px;
      margin: 0 auto;
      color: white;
      text-align: center;
      max-width: 1080px;
      min-width: 280px;
      overflow: auto;
    }

    .banner {
      border: 1px solid #0F1E17;
      border-top: 6px solid #232E28;
      background-color: #0F1E17;
      display: inline-block;
      width: 150px;
    }

    .banner h2 {
      text-align: center;
      margin: 5px;
      color: #03FB8D;
    }

    #memory_banner h2 {
      color: #3C5649;
    }

    #r_box {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: row;
    }

    #freq-con {
      align-items: flex-end;
      display: flex;
      justify-content: end;
      margin: 10px;
      position: absolute;
      height: unset;
      top: 180px;
      margin-left: 150px;
    }

    #bars-con {
      align-items: flex-start;
      display: flex;
      justify-content: space-around;
      height: 100%;
      flex-direction: column;
    }

    .freq {
      color: #03FB8D;
      font-size: 36px;
    }

    .arrow {
      background-color: #0F1E17;
      width: 60px;
      height: 50px;
      font-size: 40px;
    }

    .fa-caret-left,
    .fa-caret-right {
      margin-left: 20px;
    }

    .caret {
      font-size: 50px;
      color: #03FB8D;
    }

    #receiver-box {
      height: 150px;
      width: 300px;
      background-color: #0F1E17;
      margin: 10px;
    }

    .bar {
      height: 10px;
      background-color: #397975;
      /* #03FB8D */
      width: 100px;
    }

    #dummy-div,
    #dummy-div_2 {
      display: none;
    }

    .char-box {
      height: 100%;
      margin: 20px;
      border: 2px solid #03FB8D;
      background-image: url('../Images/static.gif');
      background-size: cover;
      min-width: 180px;
    }

    .overlay {
      height: 100%;
      background-color: #03FB8D;
      opacity: 0.3;
    }

    #c-char {
      text-align: center;
      font-size: 15px;
    }

    #alt-box {
      display: none;
    }

    /* 1080 */
    @media screen and (max-width: 1080px) {
      .char-box {
        margin: 0px;
        border: none;
      }
    }

    /* 870 */
    @media screen and (max-width: 870px) {
      #main-box {
        height: 250px;
      }

      #main-con {
        height: 200px;
      }

      .codec-col {
        height: 200px;
      }

      .bar {
        height: 5px;
      }

      .char-box {
        min-width: 100px;
      }

      #receiver-box {
        width: 150px;
        overflow: hidden;
        height: 70px;
      }

      #freq {
        font-size: 26px;
      }

      #freq-con {
        top: 130px;
        margin-left: 90px;
      }

      #text-con {
        height: 250px;
      }

      #freq {
        font-size: 16px;
      }
    }

    /* 800 */


    /* 320 */
    @media screen and (max-width: 550px) {
      #main-con {
        height: 120px;
        margin-bottom: 10px;
        padding: 0px;
      }

      #mCodec {
        padding: 0px;
      }

      #alt-box {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: row;
      }

      .fa-caret-left,
      .fa-caret-right {
        margin-left: 0px;
      }

      #text-con {
        font-size: 12px;
        min-width: 100px;
        height: 200px;
      }

      #freq-con,
      #left,
      #right {
        display: none;
        margin: 10px;
      }

      .arrow {
        background-color: transparent;
        width: auto;
      }

      .freq {
        color: #03FB8D;
        font-size: 26px;
        margin: 10px;
      }

      .codec-col {
        height: 100%;
      }

      #receiver-box {
        height: 40px;
        width: 100px;
      }

      .banner {
        font-size: 5px;
        width: 50px;
      }

      #main-receiver {
        min-width: 100px;
      }

      #codec_banner {
        width: 60px;
      }

      .char-box {
        min-width: 70px;
        margin: 5px;
      }

      .bar {
        height: 3px;
      }
    }

    @media screen and (max-width: 290px) {
      #receiver-box {
        width: 90px;
      }
    }


    /* Height */

    @media screen and (min-height: 540px) {
      #text-con {
        height: 300px;
      }
    }
  </style>
  <script>
    window.console = window.console || function (t) { };
  </script>



</head>

  <body translate="no">
    --- <!-- Take this piece out and the whole thing comes crumbling down! -->
    <div id="mCodec">
      <div id="main-con">
        <div id="contact_1" class="grid-box codec-col">
          <div id="char-1" class="char-box"
            style="background-image: url(&quot;https://static.wikia.nocookie.net/metalgear/images/3/36/Hal_Emmerich.jpg/revision/latest?cb=20060926152439&quot;);">
            <div class="overlay">
            </div>
          </div>
        </div>
        <div id="main-receiver" class="body-box codec-col">
          <div id="codec_banner" class="banner">
            <h2>PTT</h2>
          </div>

          <div id="r_box">
            <div id="left" class="arrow">
              <i class="fa fa-caret-left caret" aria-hidden="true"></i>
            </div>
            <div id="receiver-box">
              <div id="bars-con">
                <div class="bar" style="width: 90%; display: none; background-color: rgb(3, 251, 141);"></div>
                <div class="bar" style="width: 80%; background-color: rgb(57, 121, 117);"></div>
                <div class="bar" style="width: 70%; background-color: rgb(57, 121, 117);"></div>
                <div class="bar" style="width: 60%; background-color: rgb(3, 251, 141);"></div>
                <div class="bar" style="width: 50%; background-color: rgb(3, 251, 141);"></div>
                <div class="bar" style="width: 40%; background-color: rgb(3, 251, 141);"></div>
                <div class="bar" style="width: 30%; background-color: rgb(3, 251, 141);"></div>
                <div class="bar" style="width: 20%; background-color: rgb(3, 251, 141);"></div>
                <div class="bar" style="width: 10%; background-color: rgb(3, 251, 141);"></div>
              </div>
              <div id="freq-con">
                <h2 id="freq" class="freq">140.15</h2>
              </div>
            </div>
            <div id="right" class="arrow">
              <i class="fa fa-caret-right caret" aria-hidden="true"></i>
            </div>
          </div>

          <div id="memory_banner" class="banner">
            <h2>MEMORY</h2>
          </div>
        </div>
        <div id="contact_2" class="grid-box codec-col">
          <div id="char-2" class="char-box"
            style="background-image: url(&quot;https://static.wikia.nocookie.net/metalgear/images/6/60/Solid_Snake%27s_sneaking_Suit.jpg/revision/latest?cb=20100131174520&quot;);">
            <div class="overlay">
            </div>
          </div>
        </div>
      </div>

      <div id="text-con">
        <h2 id="c-char">Otacon:</h2>
        <h3 id="text">Snake! This is your first time using the Codec system. Let me explain to you how it works. First, to
          continue this conversation, click within this box!</h3>
      </div>

      <div id="alt-box">
        <div id="left_2" class="left arrow">
          <i class="fa fa-caret-left caret" aria-hidden="true"></i>
        </div>
        <div class="freq-con">
          <h2 id="freq_2" class="freq">140.15</h2>
        </div>
        <div id="right_2" class="right arrow">
          <i class="fa fa-caret-right caret" aria-hidden="true"></i>
        </div>
      </div>
    </div>
    <script id="rendered-js">
      // MGS1 = 15512
      // MGS2 = 11471
      // MGS3 = 227
      // MGS4 = 11783
      // MGSPO = ???
      // FOX Unit history
      var currentGame = '15512';
      var currentCodec = '';

      /* To create the bar effect */
      var iniWidth = 100;
      var barWidth = $('#bars-con').children();
      for (var increaseWidth = 1; increaseWidth < barWidth.length + 1; increaseWidth++) {
        if (window.CP.shouldStopExecution(0)) break;
        $('#bars-con').children().eq(increaseWidth - 1).css('width', 10 * (barWidth.length - increaseWidth + 1) + '%');
      }

      // To create the 'bar' color changing effect
      window.CP.exitedLoop(0); var bSignal = barWidth.length;
      var signalCount = bSignal;
      var dBar = true;
      var endFunc = false;
      var running = false;

      function barSignal(chk = false) {
        if (running !== true || chk === true) {
          setTimeout(function () {
            running = true;
            if (dBar === true) {
              signalCount--;
              $('#bars-con').children().eq(signalCount).css('background-color', '#03FB8D');
              if (signalCount === 0) {
                dBar = false;
              }
            } else {
              signalCount++;
              $('#bars-con').children().eq(signalCount).css('background-color', '#397975');

              if (signalCount === bSignal) {
                dBar = true;
                if (endFunc === true) {
                  running = false;
                  return false;
                }
              }
            }

            barSignal(true);
          }, 100);
        }
      };

      barSignal();
      $('#bars-con').children().eq(0).css('display', 'none');

      /* How the codec works
      
        You press the arrows < > to change freq, each setting will have its own set of frequencies (i.e, MGS: 140.15, 140.48...)
        Each time you'll get a random conversation picked randomly from the codec object
        After the conversation has ended, static will be displayed on the images, and a message will appear saying that the conversation has ended
      
      */

      var games = {
        '227': { /* CHANGE */
          'frequencies': ['140.15', '140.48', '140.96', '140.85', '141.52', '141.12', '141.80']
        },

        '11471': { /* CHANGE */
          'frequencies': ['140.15', '140.48', '140.96', '140.85', '141.52', '141.12', '141.80'],
          'gallery': '150'
        },

        '15512': {
          'frequencies': ['140.15', '140.48', '140.96', '140.85', '141.52', '141.12', '141.80'],
          'gallery': '149'
        },

        '11783': {
          'frequencies': ['140.15', '140.48', '140.96', '140.85', '141.52', '141.12', '141.80']
        }
      };



      $.ajax('https://metalgear.wikia.com/api.php?format=json&action=query&prop=revisions&rvprop=content&pageids=' + currentGame + '&rvparse=1', { // Add &rvparse=1 for html response
        dataType: 'jsonp'
      }).
        done(function (data) {
          //console.log(data);
          /* How codec(s) should be stored
            var codec = {
            'Snake finds food': {
              characters = ['Snake', 'Major', 'Para-Medic']
              conversations = [
                ['Major', 'Snake, did you find food? '],
                ['Snake', 'Yeah.' ],
                ['Para-Medic', 'You sound happy.'],
              ]
            }
            } */



          var codec = {};
          var characters = [];
          var cImages;

          // Change the freq header innerHTML to first index of the frequencies array in the games object

          var freqCount = 0;
          function currentFreq(freq) {
            //document.querySelector('.freq').innerHTML = freq
            $('.freq').text(freq);
          }

          currentFreq(games[currentGame]['frequencies'][freqCount]);


          // Get the text
          var text = data.query.pages[Object.keys(data.query.pages)[0]].revisions[0]['*'];

          // Get all headers
          /* Headers are within three equal signs '=== Snake finds food ==='
            I should get the first occurrence, and the second, then repeat
          */
          var dDiv = document.querySelector('#dummy-div');
          dDiv.innerHTML = text;

          var headers = dDiv.querySelectorAll('h3');
          var topics = [];

          // Get all the <i> tags
          var iRobot = dDiv.querySelectorAll('i');
          // Removes those <i> tags that contain a specific string
          for (var d = 0; d < iRobot.length; d++) {
            if (window.CP.shouldStopExecution(1)) break;
            //if (iRobot[d].textContent.includes('To initiate this conversation') === true || iRobot[d].textContent.includes('To unlock this conversation') === true || iRobot[d].textContent.includes('To obtain this conversation') === true) { // Make this smaller [[In order to access this conversation
            iRobot[d].parentNode.removeChild(iRobot[d]); // Removes ALL <i> tags, while the if statement (commented out) will remove only <i> with selected text in it 
            //}
          }

          // Get all the <h4> tags
          window.CP.exitedLoop(1); var theH4ters = dDiv.querySelectorAll('h4');

          // Removes those <h4> tags, and <p> tags (if they are directly after the <h4>
          for (var h = 0; h < theH4ters.length; h++) {
            if (window.CP.shouldStopExecution(2)) break;
            if (theH4ters[h].nextElementSibling.nodeName === 'p') {
              theH4ters[h].nextElementSibling.parentNode.removeChild(theH4ters[h].nextElementSibling);
            };
            theH4ters[h].parentNode.removeChild(theH4ters[h]);
          }

          // Removes those <h2> tags
          window.CP.exitedLoop(2); $('#dummy-div').find('h2').remove();


          // Get all the 'headers' (Conversation topics)
          for (var i = 0; i < headers.length; i++) {
            if (window.CP.shouldStopExecution(3)) break;
            var x = headers[i].querySelectorAll('span')[0].innerHTML;
            topics.push(x);
            codec[x] = { 'characters': [], 'conversations': [] };

            var headerConvo = $(headers[i]).nextUntil(headers[i + 1]);
            for (var m = 0; m < headerConvo.length; m++) {
              if (window.CP.shouldStopExecution(4)) break;
              //codec[x]['conversations'].push(headerConvo[m].innerHTML)

              // Get characters within <b> tags
              if (headerConvo[m].querySelectorAll('b').length > 0) {
                var chars = headerConvo[m].querySelectorAll('b');
                // Get all the characters
                var b = headerConvo[m].querySelectorAll('b')[0].innerHTML.replace(/[$/:-?{-~!"^_`'\[\]]/g, '');
                // Remove space at the end of the string
                if (b[b.length - 1] == ' ') {
                  b = b.slice(0, -1);
                }

                if (characters.includes(b) !== true) {// Check what to parse and make a comment for it
                  characters.push(b);
                }
              }

              if (headerConvo[m].querySelectorAll('b').length > 0) {
                // Does it have <b> as a child?
                try {
                  var convo = headerConvo[m].removeChild(headerConvo[m].querySelectorAll('b')[0]);
                }
                catch (error) {
                  //console.log('Could not find <b>!');
                }
                //console.log(convo);
              }

              if (headerConvo[m].textContent.replace(/\r?\n|\r/g, '') !== '') {

                for (var cLen = 0; cLen < characters.length; cLen++) {
                  if (window.CP.shouldStopExecution(5)) break; // Takes out words like ('Snake:') to improve parsing
                  headerConvo[m].textContent = headerConvo[m].textContent.replace(characters[cLen] + ':', '');
                } window.CP.exitedLoop(5);

                headerConvo[m].textContent = headerConvo[m].textContent.replace(':', '');

                codec[x]['conversations'].push([b, headerConvo[m].textContent.replace(/\r?\n|\r/g, '')]); // Character

                if (codec[x]['characters'].indexOf(b) === -1) {
                  codec[x]['characters'].push(b);
                };
              }
            } window.CP.exitedLoop(4);
            $('#dummy-div').remove();

          } window.CP.exitedLoop(3);

          function startTut() {
            codec['Start Tutorial'] = {
              "characters": [
                "Otacon",
                "Snake"],

              "conversations": [
                [
                  "Otacon",
                  "Snake! This is your first time using the Codec system. Let me explain to you how it works. First, to continue this conversation, click within this box!"],

                [
                  "Snake",
                  "...Okay?"],

                [
                  "Otacon",
                  " Good Snake! Now, if you want to initiate another conversation, click the green arrows. Note, these arrows may be either above this box or below, depending on your screen size!"],

                [
                  "Snake",
                  "Right..."]]
            };

            currentCodec = codec['Start Tutorial']['conversations'];
          };

          startTut();

          var count = 0;
          function currentConversation(click, manual = false) {
            //if (Object.values(click)[0] === true) {
            if (typeof click === 'object') {
              if (count !== currentCodec.length) {
                count++;
              }
            } else {
              count = 0;
            }
            // if length is max > next click will be 'end transmission'
            //console.log(currentCodec);
            if (currentCodec[count] !== undefined && manual === false) {
              document.querySelector('#text').innerHTML = currentCodec[count][1];
              if (currentCodec[count][0].indexOf('Snake') === -1) {
                $('#char-1').css('background-image', 'url(' + cImages[currentCodec[count][0]].image + ')');
              }

              $('#c-char').text(currentCodec[count][0] + ':');
              $('#char-2').css('background-image', 'url(' + cImages['Snake'].image + ')');
            } else if (manual !== false) {
              document.querySelector('#text').innerHTML = codec['Start Tutorial']['conversations'][count][1]; //currentCodec[count][1];
              if (codec['Start Tutorial']['conversations'][count][0].indexOf('Snake') === -1) {
                $('#char-1').css('background-image', 'url(' + cImages[codec['Start Tutorial']['conversations'][count][0]].image + ')');
              }

              $('#c-char').text(codec['Start Tutorial']['conversations'][count][0] + ':');
              $('#char-2').css('background-image', 'url(' + cImages['Snake'].image + ')');
            } else {
              endFunc = true;
              document.querySelector('#text').innerHTML = '*END TRANSMISSION*';
              $('#c-char').text('');
              $('.char-box').css('background-image', 'url("https://raw.githubusercontent.com/TylerJCodes/MGS-Codec/master/Images/static.gif")');
            }
          };

          document.querySelector('#text-con').addEventListener('click', currentConversation);

          /* For when the arrow(s) are clicked */
          function changeFreq() {
            var id = this.getAttribute("id");
            endFunc = false;
            barSignal();
            if (id === 'right' || 'right_2') {
              // If reached max freq index
              if (freqCount === games[currentGame]['frequencies'].length - 1) {
                freqCount = 0;
              } else {
                freqCount++;
              }
              currentFreq(games[currentGame]['frequencies'][freqCount]);
            } else {
              // as above, so below
              if (freqCount === 0) {
                freqCount = games[currentGame]['frequencies'].length - 1;
              } else {
                freqCount--;
              }
              currentFreq(games[currentGame]['frequencies'][freqCount]);
            }

            // get random codec conversation from codec object
            var codecL = Object.keys(codec);
            var rNum = Math.floor(Math.random() * (codecL.length - 0) + 0);
            currentCodec = codec[codecL[rNum]]['conversations'];
            currentConversation(false);
          }

          //console.log(codec);
          // Get the character image(s)
          function getImages(id) {
            $.ajax('https://metalgear.wikia.com/api.php?format=json&action=query&prop=revisions&rvprop=content&pageids=' + id + '&rvparse=1', { // Add &rvparse=1 for html response
              dataType: 'jsonp'
            }).
              done(function (nData) {
                //console.log(nData);
                var text2 = nData.query.pages[Object.keys(nData.query.pages)[0]].revisions[0]['*'];
                var dDiv2 = document.querySelector('#dummy-div_2');
                dDiv2.innerHTML = text2;
                var characterImages = {};

                // lightbox-caption div contains the name(s) of the images
                $('.lightbox-caption').each(function () {
                  var linkOf = $(this).siblings('.thumb').find('img').attr('data-src');
                  linkOf = linkOf.replace('/scale-to-width-down/', '');
                  var x1 = linkOf.lastIndexOf('latest'); var x2 = linkOf.lastIndexOf('?');
                  linkOf = linkOf.substring(0, x1 + 'latest'.length) + linkOf.substring(x2, linkOf.length);

                  //console.log($(this).children('a').text());
                  if (characters.indexOf($(this).children('a').text()) > -1) {
                    characterImages[characters[characters.indexOf($(this).children('a').text())]] = { 'image': linkOf };
                    if ($(this).children('a').text() === 'Solid Snake') {
                      characterImages['Snake'] = { 'image': linkOf };
                    } else if ($(this).children('a').text() === 'Roy Campbell') {
                      characterImages['Campbell'] = { 'image': linkOf };
                    } else if ($(this).children('a').text() === 'Nastasha Romanenko') {
                      characterImages['Nastasha Romenanko'] = { 'image': linkOf };
                      characterImages['Nastaha Romanenko'] = { 'image': linkOf };
                      characterImages['Nastasha Romenenko'] = { 'image': linkOf };
                    } else if ($(this).children('a').text() === 'Naomi Hunter') {
                      characterImages['Naomi'] = { 'image': linkOf };
                    };
                  } else {
                    //console.log('Couldn\'t find ' + $(this).children('a').text() + '!');
                    if ($(this).children('a').text() === 'Hal Emmerich') {
                      characterImages['Otacon'] = { 'image': linkOf };
                    }

                    if (characters.indexOf($(this).children('a').text().split(' ')[0]) > -1) {
                      characterImages[characters[characters.indexOf($(this).children('a').text().split(' ')[0])]] = { 'image': linkOf };
                    };
                  }
                });

                //console.log(characterImages);

                var arrows = document.querySelectorAll('.arrow');
                for (var addEvent = 0; addEvent < arrows.length; addEvent++) {
                  if (window.CP.shouldStopExecution(6)) break;
                  arrows[addEvent].addEventListener('click', changeFreq);
                } window.CP.exitedLoop(6);

                cImages = characterImages;
                currentConversation(true, true);

                $('#dummy-div_2').remove();
              });
          };

          getImages(games[currentGame].gallery);
          //console.log(characters);
        });
      //# sourceURL=pen.js
    </script>
  </body>
</html>